<!DOCTYPE html>
<!--
* ==============================================================================
 * IMPORTANT NOTICE / é‡è¦äº‹é …
 * ==============================================================================
 * Copyright (c) 2025-2026 ã­ãŠã‚“ (Neon)
 * Licensed under the PolyForm Noncommercial License 1.0.0.
 * https://polyformproject.org/licenses/noncommercial/1.0.0/
 * [JP] æœ¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ï¼ˆHTML/CSS/JSï¼‰ã¯ã€å€‹äººåˆ©ç”¨ãƒ»éå–¶åˆ©ç›®çš„ã§ã®ã¿ä½¿ç”¨ãƒ»æ”¹å¤‰ãŒè¨±å¯ã•ã‚Œã¾ã™ã€‚
 * ç„¡æ–­ã§ã®å†å…¬é–‹ï¼ˆãƒŸãƒ©ãƒ¼ã‚µã‚¤ãƒˆã€è»¢è¼‰ï¼‰ã€ä½œè€…åã®æ›¸ãæ›ãˆã€ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã®å‰Šé™¤ã¯å›ºãç¦ã˜ã¾ã™ã€‚
 * æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ”¹å¤‰ãƒ»é…å¸ƒï¼ˆãƒ•ã‚©ãƒ¼ã‚¯ï¼‰ã™ã‚‹å ´åˆã¯ã€å¿…ãšå…ƒã®ä½œè€…åï¼ˆã­ãŠã‚“ï¼‰
 * ãŠã‚ˆã³ã“ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨è¨˜ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚
 * [EN] The code of this application (HTML/CSS/JS) is licensed for personal
 * and non-commercial use only. Unauthorized re-uploading, mirroring,
 * modification of authorship, or removal of author credits is strictly prohibited.
 * If you fork this project, you MUST retain the original credits and authorship.
 * ==============================================================================
-->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ ãƒ•ã‚£ã‚®ãƒ¥ã‚¢åŒ–ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <meta name="author" content="ã­ãŠã‚“">
    <meta name="license" content="PolyForm Noncommercial 1.0.0">
    <!-- Tailwind CSSã®CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fontsã¨Material Iconsã®CDNã‚’èª­ã¿è¾¼ã¿ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=M+PLUS+Rounded+1c:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0..200" rel="stylesheet">
    <style>
        /* åŸºæœ¬çš„ãªã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', 'M PLUS Rounded 1c', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            max-width: 1024px;
            margin: auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .card {
            background-color: #2d3748;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .image-preview-container {
            border: 2px dashed #4a5568;
            background-color: #242b38;
            border-radius: 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            height: 300px;
        }
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-fit-contain {
            object-fit: contain;
        }
        .drop-zone-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
            cursor: pointer;
        }

        /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®çŸ¢å°ã®ä½ç½®èª¿æ•´ */
        select {
            /* 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŸ¢å°ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
            -webkit-appearance: none; /* Webkitãƒ–ãƒ©ã‚¦ã‚¶ç”¨ */
            -moz-appearance: none;    /* Firefoxç”¨ */
            appearance: none;         /* æ¨™æº– */

            /* 2. ã‚«ã‚¹ã‚¿ãƒ ã®çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚’èƒŒæ™¯ç”»åƒã¨ã—ã¦é…ç½® */
            /* ã“ã“ã§ã¯ã€ç™½ã„ä¸‹å‘ãçŸ¢å°ã®SVGãƒ‡ãƒ¼ã‚¿URIã‚’ä½¿ç”¨ */
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='none' stroke='white' stroke-width='2' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;

            /* 3. çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
            /* right: çŸ¢å°ãŒå³ç«¯ã‹ã‚‰ 0.75rem (Tailwindã®3ã«ç›¸å½“) ã®ä½ç½®ã«æ¥ã‚‹ã‚ˆã†ã«è¨­å®š */
            background-position: right 0.75rem center;
            background-size: 1.5rem; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚º */

            /* 4. çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆãŒé‡ãªã‚‰ãªã„ã‚ˆã†ã«å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¨­å®š */
            /* HTMLã®ã‚¯ãƒ©ã‚¹ã¯ãã®ã¾ã¾ 'px-4' ã§ã€CSSã§å³å´ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ã™ã‚‹ */
            padding-right: 2.5rem !important; /* px-4 (1rem) ã‚ˆã‚Šã‚‚å¤§ããã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); }
        }
        @keyframes spin-and-bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(180deg); }
        }
        @keyframes wiggle {
            0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); }
        }
        @keyframes waddle-walk {
            0% { transform: translateX(0) rotate(0deg); } 25% { transform: translateX(-5px) rotate(-5deg); }
            50% { transform: translateX(0) rotate(0deg); } 75% { transform: translateX(5px) rotate(5deg); }
            100% { transform: translateX(0) rotate(0deg); }
        }
        .anim-bounce {
            animation: bounce 1s infinite;
            display: inline-block;
        }
        .anim-spin-bounce {
            animation: spin-and-bounce 1.5s infinite cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: inline-block;
        }
        .anim-wiggle {
            animation: wiggle 0.5s infinite ease-in-out;
            display: inline-block;
        }
        .anim-waddle {
            animation: waddle-walk 0.8s infinite;
            display: inline-block;
        }
        /* ç”»åƒä¸Šã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20; /* download-btnã‚ˆã‚Šã¯ä¸‹ã€ç”»åƒã‚ˆã‚Šã¯ä¸Š */
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã¨ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .icon-btn {
            position: absolute;
            background-color: rgba(45, 55, 72, 0.8);
            color: white;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .icon-btn:hover {
            background-color: rgba(74, 85, 104, 0.9);
        }
        .icon-btn:visited {
            background-color: rgba(45, 55, 72, 0.8);
        }
        #copy-negative-prompt-btn .material-symbols-outlined {
            color: #C34A4A;
        }
        .tooltip-arrow::after {
            content: "";
            position: absolute;
            bottom: 100%;
            right: 20px;
            border-width: 8px;
            border-style: solid;
            border-color: transparent transparent #374151 transparent;
        }
        .prompt-tooltip-container {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        .prompt-tooltip {
            position: relative;
        }
        .prompt-tooltip .prompt-tooltip-text {
            visibility: hidden;
            width: 420px;
            background-color: rgba(17, 24, 39, 0.9);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 100%;
            right: 0;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.5;
            max-height: 420px;
            overflow-y: auto;
            word-break: break-all;
            white-space: pre-wrap;
        }
        .prompt-tooltip:hover .prompt-tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Style for tooltip icon and box */
        .tooltip-container {
            position: relative;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        .info-icon {
            font-size: 1.2rem;
            color: #888;
            cursor: pointer;
        }
        .tooltip-box {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸Šã«è¡¨ç¤º */
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal; /* æŠ˜ã‚Šè¿”ã—ã‚’æœ‰åŠ¹ã« */
        }
        .tooltip-box p {
            margin: 0;
            font-size: 1.0rem;
            line-height: 1.4;
        }
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹ */
        .tooltip-container:hover .tooltip-box {
            visibility: visible;
            opacity: 1;
        }

        #scroll-to-top-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }
        #scroll-to-top-btn.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* åå­—ã‚«ãƒ¼ã‚½ãƒ«ã§ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
        .click-to-fix-cursor {
            cursor: crosshair;
        }

        /* ç”»åƒã‚’å·¦å³åè»¢ã•ã›ã‚‹ãŸã‚ã®CSSã‚¯ãƒ©ã‚¹ */
        #generated-image {
            /* å·¦å³åè»¢ã®ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’ 0.3ç§’é–“ã‹ã‘ã¦å®Ÿè¡Œ */
            transition: transform 0.3s ease-in-out;
            /* isImageFlippedãŒfalseã®ã¨ãã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
            transform: scaleX(1);
        }
        #generated-image.flipped {
            /* æ°´å¹³æ–¹å‘ï¼ˆXè»¸ï¼‰ã«ç”»åƒã‚’åè»¢ã•ã›ã‚‹ */
            transform: scaleX(-1);
        }
        /* flip-image-btnã®ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä¾‹ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç°è‰²ç³»ï¼‰ */
        #flip-image-btn {
            transition: all 0.2s ease-in-out; /* è‰²ã‚„å½±ã‚‚æ»‘ã‚‰ã‹ã«å¤‰åŒ–ã•ã›ã‚‹ */
        }
        /* åè»¢ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã¨ãã®ã‚¹ã‚¿ã‚¤ãƒ« (is-activeã‚¯ãƒ©ã‚¹ãŒä»˜ã„ã¦ã„ã‚‹ã¨ã) */
        #flip-image-btn.is-active {
            transform: scale(1.05); /* å°‘ã—å¤§ããã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ„Ÿã‚’å‡ºã™ */
        }

        /* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
        #reset-prompts-button {
            box-shadow:
                /* [æ¨ªæ–¹å‘ã®å½±] [ç¸¦æ–¹å‘ã®å½±] [ã¼ã‹ã—] [åºƒãŒã‚Š] [è‰²] */
                0 0 3px 3px white,
                0 0 5px rgba(0, 0, 0, 0.4);
            transition: background-color 0.2s, box-shadow 0.2s; /* ãƒ›ãƒãƒ¼æ™‚ã®è¨­å®š  */
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600ç›¸å½“ */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500ç›¸å½“ */
        }

        /* è­¦å‘Šæ–‡ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #copyright-warning {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            max-width: calc(100% - 6rem);
            padding: 0.4rem;
            background-color: rgba(130, 80, 0, 0.6);  /* bg-yellow-900/80 */
            color: rgb(251, 237, 186);                /* text-yellow-200 */
            font-size: 0.75rem;                         /* text-xs */
            border-radius: 0.5rem;                      /* rounded-lg */
            border: 1px solid rgba(160, 100, 0, 0.5); /* border-yellow-700/50 */
            -webkit-backdrop-filter: blur(4px);         /* Safariå‘ã‘ */
            backdrop-filter: blur(4px);
            z-index: 10;
        }
        #error-message {
            margin-top: 1rem;
            text-align: center;
            color: #F87171; /* text-red-400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto p-4 md:p-8">
        <div class="relative text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold my-0" style="font-family: 'M PLUS Rounded 1c', sans-serif;">
                ğŸ¥ ãƒ•ã‚£ã‚®ãƒ¥ã‚¢åŒ–ãƒ¡ãƒ¼ã‚«ãƒ¼<span id="app-version" class="text-lg text-gray-400"></span>
            </h1>
            <p class="text-gray-400 mt-2 mb-4">ã‚ãªãŸã ã‘ã®ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚„ã­ã‚“ã©ã‚ã„ã©ã®ç”»åƒãŒä½œã‚Œã¡ã‚ƒã†ï¼</p>
            <div class="absolute top-0 right-0 flex items-center">
                <button id="license-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                    <span class="material-symbols-outlined w-8 h-8 flex items-center justify-center">copyright</span>
                </button>
                <div id="license-tooltip" class="hidden absolute top-full right-0 mt-2 bg-gray-700 rounded-2xl shadow-xl p-4 z-50 tooltip-arrow" style="width: 420px;">
                    <h3 class="text-lg font-bold mb-2 text-white text-left">è‘—ä½œæ¨©æƒ…å ± / Copyright</h3>
                    <div class="text-gray-300 text-left text-sm overflow-y-auto custom-scrollbar" style="max-height: 400px;">
                        <p class="font-bold">Copyright (c) 2025-2026 ã­ãŠã‚“ (Neon)</p>

                        <p class="mt-2 font-bold">åŸºæœ¬ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ / License:</p>
                        <p>PolyForm Noncommercial License 1.0.0</p>
                        <p class="text-xs text-gray-400 italic">https://polyformproject.org/licenses/noncommercial/1.0.0/</p>

                        <p class="mt-2 font-bold">â–  åˆ©ç”¨ä¸Šã®ãƒ«ãƒ¼ãƒ« (JP)</p>
                        <p>1. <strong>éå–¶åˆ©é™å®š:</strong> æœ¬ã‚¢ãƒ—ãƒªã¯å€‹äººåˆ©ç”¨ãƒ»éå–¶åˆ©ç›®çš„ã§ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ã€‚</p>
                        <p>2. <strong>ç¦æ­¢äº‹é …:</strong> å–¶åˆ©ç›®çš„ã®åˆ©ç”¨ã€ã‚³ãƒ¼ãƒ‰ã®æ”¹å¤‰ã€ç„¡æ–­ã§ã®å†é…å¸ƒï¼ˆè»¢è¼‰ãƒ»ãƒŸãƒ©ãƒ¼ç­‰ï¼‰ã€ãŠã‚ˆã³ä½œè€…åã®æ›¸ãæ›ãˆã‚’å›ºãç¦ã˜ã¾ã™ã€‚</p>
                        <p>3. <strong>æ¨©åˆ©ã®ç¶­æŒ:</strong> æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å¼•ç”¨ãƒ»å‚ç…§ã™ã‚‹å ´åˆã¯ã€å¿…ãšå…ƒã®ä½œè€…åï¼ˆã­ãŠã‚“ï¼‰ã¨ã“ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚</p>

                        <p class="mt-2 font-bold">â–  Usage Rules (EN)</p>
                        <p>1. <strong>Non-commercial Only:</strong> This app is for personal and non-commercial use only.</p>
                        <p>2. <strong>Prohibition:</strong> Commercial use, modification of code, unauthorized redistribution (mirroring), and claiming authorship are strictly prohibited.</p>
                        <p>3. <strong>Attribution:</strong> You must retain the original authorship and credits.</p>

                        <p class="mt-2 font-bold">â–  ç”Ÿæˆã—ãŸAIã‚¤ãƒ©ã‚¹ãƒˆã«ã¤ã„ã¦ / Generated Images</p>
                        <p>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨è¨˜ä¸è¦ã€‚SNSæŠ•ç¨¿æ™‚ã¯AIã‚¿ã‚°æ¨å¥¨ã€‚Googleã®åˆ©ç”¨è¦ç´„ã‚’é †å®ˆã—ã¦ãã ã•ã„ã€‚</p>
                        <p class="text-xs">No credit required. AI tags are recommended for SNS. Please comply with Google's Terms of Service.</p>
                    </div>
                </div>
            </div>
            <div class="absolute top-10 right-0 flex items-center">
                <button id="info-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                    <span class="material-symbols-outlined w-8 h-8 flex items-center justify-center gap-2">info</span></span>
                </button>
                <div id="info-tooltip" class="hidden absolute top-full right-0 mt-2 bg-gray-700 rounded-2xl shadow-xl p-4 z-50 tooltip-arrow" style="width: 420px;">
                    <h3 class="text-lg font-bold mb-2 text-white text-left">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
                    <div class="text-gray-300 text-left">
                        <p>1. ğŸ–¼ï¸ å…ƒã«ãªã‚‹ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
                        <p>2. ğŸ¤– ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã‚„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è‡ªç”±ã«é¸ã³ã¾ã™ã€‚</p>
                        <p>3. ğŸ¨ ã€Œè¿½åŠ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ã§ã€ã‚ˆã‚Šç´°ã‹ã„æŒ‡ç¤ºã‚‚ã§ãã¾ã™ã€‚</p>
                        <p>4. âœ¨ ã€Œç”Ÿæˆã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ä½œå“ãŒå®Œæˆï¼</p>
                        <p class="mt-4 font-bold text-lg">--- ç”Ÿæˆå¾Œ ---</p>
                        <p>5. ğŸ§¼ ãƒ­ã‚´ãŒæ°—ã«ãªã‚‹å ´åˆã¯ã€Œãƒ­ã‚´ä¿®æ­£ã€ï¼</p>
                        <p>6. ğŸ’ ã‚‚ã£ã¨ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã£ã½ãã—ãŸã„æ™‚ã¯ã€Œã•ã‚‰ã«å¼·åŒ–ã€ï¼</p>
                        <p>7. ğŸ‘— ã€Œã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºã€ã§ã€Œæœã®è‰²ã‚’å¤‰ãˆã¦ã€ãªã©è‡ªç”±ãªä¿®æ­£ã‚‚ã§ãã¾ã™ï¼</p>
                        <p>8. ğŸ’« ã€Œå…ƒã«æˆ»ã™ã€ã€Œã‚„ã‚Šç›´ã™ã€ã¯ã€Œâ†ã€ã€Œâ†’ã€ã‚­ãƒ¼ã§ã‚‚ã§ãã¾ã™ï¼ˆæœ€å¤§20æšï¼‰</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-0 overflow-hidden">
            <div id="drop-zone" class="image-preview-container cursor-pointer">
                <input type="file" id="file-input" class="hidden" accept="image/*" aria-label="file-input">
                <div id="drop-text" class="drop-zone-text text-gray-500">
                    <p>ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p class="my-2">ã¾ãŸã¯ã€ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                </div>
                <img id="image-preview" src="#" alt="Image Preview" class="hidden image-preview">
                <button id="reset-prompts-button" class="icon-btn top-2 right-2 p-2 opacity-0 bg-rose-500 text-white hover:bg-rose-400 w-8 h-8">
                    <span class="material-symbols-outlined text-xl">clear_all</span>
                </button>
                <button id="toggle-size-btn" class="hidden icon-btn bottom-3 right-3 p-2">
                    <span id="toggle-size-icon" class="material-symbols-outlined w-4 h-4 flex items-center justify-center gap-2 text-white">zoom_in_map</span>
                </button>
            </div>
        </div>

        <div class="card">
            <div class="grid grid-cols-[1.3fr_1fr] lg:grid-cols-[3fr_3fr_4fr] gap-4 items-center">
                <select id="mode-select" class="w-full px-4 py-3 bg-gray-800 rounded-full text-gray-200 border-2 border-gray-700 focus:border-blue-500 focus:outline-none" aria-label="mode-select">
                    <option value="basic">ãƒ™ãƒ¼ã‚·ãƒƒã‚¯</option>
                    <option value="modeling">3Dãƒ¢ãƒ‡ãƒªãƒ³ã‚°å·¥ç¨‹</option>
                    <option value="diorama">ã‚¸ã‚ªãƒ©ãƒåŒ–</option>
                </select>
                <select id="type-select" class="w-full px-4 py-3 bg-gray-800 rounded-full text-gray-200 border-2 border-gray-700 focus:border-blue-500 focus:outline-none" aria-label="type-select">
                    <option value="pvc" selected>PVCè£½ãƒ•ã‚£ã‚®ãƒ¥ã‚¢</option>
                    <option value="nendoroid">ã­ã‚“ã©ã‚ã„ã©</option>
                    <option value="clay">ç²˜åœŸç´°å·¥</option>
                    <option value="stand">ã‚¢ã‚¯ã‚¹ã‚¿</option>
                    <option value="key">ã‚¢ã‚¯ã‚­ãƒ¼</option>
                    <option value="toy">ã¬ã„</option>
                    <option value="cos">ã‚³ã‚¹ãƒ—ãƒ¬</option>
                    <option value="ghibli">ã‚¸ãƒ–ãƒªé¢¨</option>
                </select>
                <select id="package-select" name="package" class="w-full px-4 py-3 bg-gray-800 rounded-full text-gray-200 border-2 border-gray-700 focus:border-blue-500 focus:outline-none" aria-label="package-select">
                    <option value="no packaging box">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®±ãªã—</option>
                    <option value="a realistic product packaging box of an anime figure" selected>æ—¥æœ¬ã®ã‚¢ãƒ‹ãƒ¡é¢¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®±</option>
                    <option value="a retro toy-style blister pack">ãƒ¬ãƒˆãƒ­ãŠã‚‚ã¡ã‚ƒé¢¨ãƒ–ãƒªã‚¹ã‚¿ãƒ¼ãƒ‘ãƒƒã‚¯</option>
                    <option value="a luxury collector's edition box">è±ªè¯ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚ºã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ç®±</option>
                    <option value="">æŒ‡å®šã—ãªã„</option>
                </select>
                <select id="location-select" class="w-full px-4 py-3 bg-gray-800 rounded-full text-gray-200 border-2 border-gray-700 focus:border-blue-500 focus:outline-none" aria-label="location-select">
                    <option value="on a simple white background">ã‚·ãƒ³ãƒ—ãƒ«ãªç™½èƒŒæ™¯</option>
                    <option value="on a wooden table with soft lighting" selected>æœ¨è£½ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸Š</option>
                    <option value="in a glass showcase">ã‚¬ãƒ©ã‚¹ã®ã‚·ãƒ§ãƒ¼ã‚±ãƒ¼ã‚¹</option>
                    <option value="with a futuristic cityscape background">è¿‘æœªæ¥çš„ãªè¡—ä¸¦ã¿ã®èƒŒæ™¯</option>
                    <option value="marin blue sea and white sandy beach background">ç´ºç¢§ã®æµ·ã¨ç™½ã„ç ‚æµœ</option>
                    <option value="in a cozy and detailed bedroom background">æœã®å…‰ãŒå·®ã—è¾¼ã‚€å¯å®¤</option>
                    <option value="">æŒ‡å®šã—ãªã„</option>
                </select>
                <select id="stand-select" class="w-full px-4 py-3 bg-gray-800 rounded-full text-gray-200 border-2 border-gray-700 focus:border-blue-500 focus:outline-none" aria-label="stand-select">
                    <option value="without a base">å°åº§ãªã—</option>
                    <option value="a simple black circular base" selected>ã‚·ãƒ³ãƒ—ãƒ«ãªé»’ã„å††å½¢å°åº§</option>
                    <option value="on a rock-like diorama base">å²©ã®ã‚ˆã†ãªã‚¸ã‚ªãƒ©ãƒå°åº§</option>
                    <option value="a base with magic circle effects">é­”æ³•é™£ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä»˜ãå°åº§</option>
                    <option value="a transparent acrylic base">é€æ˜ã‚¢ã‚¯ãƒªãƒ«å°åº§</option>
                    <option value="">æŒ‡å®šã—ãªã„</option>
                </select>
                <select id="aspect-ratio-select" class="w-full px-4 py-3 bg-gray-800 rounded-full text-gray-200 border-2 border-gray-700 focus:border-blue-500 focus:outline-none" aria-label="aspect-ratio-select">
                    <option value="auto" selected>ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”:ã‚ªãƒªã‚¸ãƒŠãƒ«</option>
                    <option value="1:1">1:1 ï¼ˆæ­£æ–¹å½¢ï¼‰</option>
                    <option value="3:2">3:2 ï¼ˆæ¨ªé•· å†™çœŸã‚µã‚¤ã‚ºï¼‰</option>
                    <option value="2:3">2:3 ï¼ˆç¸¦é•· å†™çœŸã‚µã‚¤ã‚ºï¼‰</option>
                    <option value="4:3">4:3 ï¼ˆæ¨ªé•· æ—§TVã‚µã‚¤ã‚ºï¼‰</option>
                    <option value="3:4">3:4 ï¼ˆç¸¦é•· æ—§TVã‚µã‚¤ã‚ºï¼‰</option>
                    <option value="16:9">16:9 ï¼ˆæ¨ªé•· å‹•ç”»ã‚µã‚¤ã‚ºï¼‰</option>
                    <option value="9:16">9:16 ï¼ˆç¸¦é•· å‹•ç”»ã‚µã‚¤ã‚ºï¼‰</option>
                </select>
                <div class="h-full flex items-center justify-center">
                    <button id="multi-generate-toggle" data-is-multi="false" class="w-auto h-10 bg-blue-500 hover:bg-blue-400 text-white font-bold py-3 px-4 rounded-full text-sm transition-transform transform hover:scale-105 duration-150 ease-in-out flex items-center justify-center disabled:bg-gray-700 disabled:text-gray-400 disabled:cursor-not-allowed disabled:hover:scale-100" disabled>
                        <span class="material-symbols-outlined align-middle mr-2">grid_view</span>
                        <span>ï¼”æš</span>
                    </button>
                </div>
                <button id="generate-btn" class="w-full h-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:scale-100 flex items-center justify-center">
                    <span class="material-symbols-outlined align-middle mr-2">auto_awesome</span>ç”Ÿæˆã™ã‚‹
                </button>
            </div>
        </div>

        <div class="card">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-lg font-bold mb-2 flex items-center">
                        è¿½åŠ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                        <div class="ml-4 flex items-center">
                            <label for="autoTranslateSwitch" class="text-sm font-normal text-gray-400 mr-2">è‡ªå‹•ç¿»è¨³:</label>
                            <input type="checkbox" id="autoTranslateSwitch" class="form-checkbox h-4 w-4 text-gray-400 border-gray-400 transition duration-150 ease-in-out" checked>
                        </div>
                        <div class="tooltip-container">
                            <span class="material-symbols-outlined info-icon relative top-[3px]">info</span>
                            <div class="tooltip-box" style="width: 420px;">
                                <p>ğŸ“Œ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«æ—¥æœ¬èªã‚’æ›¸ãæ–¹æ³•</p>
                                <p>AIã¯æ–‡å­—ã®å½¢ã‚’èªè­˜ã™ã‚‹ã®ãŒè‹¦æ‰‹ã§ã™ã€‚ç‰¹å®šã®æ–‡å­—ã‚’æ›¸ããŸã„å ´åˆã¯ã€è‹±èªã§ãƒ•ã‚©ãƒ³ãƒˆã‚„æ–‡å­—ã®è‰²ãªã©ã‚’å…·ä½“çš„ã«æŒ‡ç¤ºã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚</p>
                                <p>ä¾‹: (on the package, realistic and clearly visible text, in Japanese hiragana "ã­ãŠã‚“", handwritten font, light blue color)</p>
                            </div>
                        </div>
                    </h3>
                    <textarea id="additional-prompt" rows="1" class="w-full p-3 bg-gray-800 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹ï¼šç¬‘é¡”ã€ã¯ã«ã‹ã‚€ã€å£ã‚’å°‘ã—é–‹ã‘ã¦ã„ã‚‹"></textarea>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-2 flex items-center">è¿½åŠ ã®ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ </h2>
                    <textarea id="additional-negative-prompt" rows="1" class="w-full p-3 bg-gray-800 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹ï¼šãƒ¡ã‚¬ãƒã€å¸½å­"></textarea>
                </div>
            </div>
        </div>

        <div id="error-message" class="card hidden"></div>

        <div id="output-section" class="card hidden">
            <h2 class="text-2xl font-bold mb-4">ç”Ÿæˆçµæœ</h2>
            <div id="loading" class="flex flex-col items-center justify-center p-8 hidden">
                <div id="loading-animation" class="text-5xl">
                    <span class="hidden anim-bounce">ğŸ¥</span>
                    <span class="hidden anim-spin-bounce">ğŸ£</span>
                    <span class="hidden anim-wiggle">ğŸ¥š</span>
                    <span class="hidden anim-waddle">ğŸ¤</span>
                </div>
                <p id="loading-text" class="mt-4 text-gray-400">ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚’ç”Ÿæˆä¸­â€¦</p>
            </div>
            <div id="result-container" class="hidden">
                <div class="relative rounded-lg overflow-hidden bg-gray-900">
                    <div id="copyright-warning" class="hidden">
                        <p><span class="font-bold">ã€æ³¨æ„ã€‘</span><br>
                        è‘—ä½œæ¨©ä¾µå®³ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãƒ­ã‚´ã‚„å•†æ¨™ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚<br>
                        ä¿®æ­£ã‚’è©¦ã¿ã¾ã—ãŸãŒã€ã”è‡ªèº«ã§ã”ç¢ºèªã®ä¸Šã§ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
                    </div>
                    <img id="generated-image" src="#" alt="Generated Image" class="w-full h-auto">
                    <a id="download-btn" href="#" download="figure_maker.png" class="icon-btn top-3 right-3 p-2 w-9 h-9">
                        <span class="material-symbols-outlined text-white">download</span>
                    </a>
                    <div id="flip-controls" style="position: absolute; bottom: 0.75rem; left: 0.75rem;">
                        <button id="flip-image-btn" class="icon-btn p-2 relative bg-gray-700 hover:bg-gray-600 w-10 h-10"><span class="material-symbols-outlined text-sm">flip</span></button>
                    </div>
                    <div class="prompt-tooltip-container">
                        <div class="prompt-tooltip">
                            <button id="copy-all-prompts-btn" class="icon-btn p-2 relative w-10 h-10"><span class="material-symbols-outlined text-sm">content_copy</span></button>
                            <span id="prompt-output-tooltip" class="prompt-tooltip-text"></span>
                        </div>
                    </div>
                    <!-- ç”»åƒä¸Šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
                    <div id="image-loading-overlay" class="image-loading-overlay hidden">
                        <div id="image-loading-animation" class="text-5xl">
                            <span class="hidden anim-bounce">ğŸ¥</span>
                            <span class="hidden anim-spin-bounce">ğŸ£</span>
                            <span class="hidden anim-wiggle">ğŸ¥š</span>
                            <span class="hidden anim-waddle">ğŸ¤</span>
                        </div>
                        <p id="image-loading-text" class="mt-4 text-white"></p>
                    </div>
                </div>
                <div id="action-area" class="hidden">
                    <div class="flex flex-row items-center justify-center gap-2 mt-2">
                        <button id="fix-logo-btn" class="btn w-auto h-10 py-2 px-4 bg-blue-400 hover:bg-blue-500 text-white font-semibold rounded-full text-sm flex items-center justify-center gap-2 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed"><span class="material-symbols-outlined">ink_eraser</span>ãƒ­ã‚´ä¿®æ­£</button>
                        <button id="fix-closeup-btn" class="btn w-auto h-10 py-2 px-4 bg-emerald-400 hover:bg-emerald-500 text-white font-semibold rounded-full text-sm flex items-center justify-center gap-2 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed"><span class="material-symbols-outlined">familiar_face_and_zone</span>Close-UP</button>
                        <button id="further-figure-btn" class="btn w-auto h-10 py-2 px-4 bg-purple-400 hover:bg-purple-500 text-white font-semibold rounded-full text-sm flex items-center justify-center gap-2 mr-2 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed"><span class="material-symbols-outlined">wand_stars</span>ã•ã‚‰ã«å¼·åŒ–</button>
                        <button id="undo-btn" class="btn rounded-full w-10 h-10 flex items-center justify-center transition-colors bg-teal-600 hover:bg-teal-500 disabled:bg-gray-800 disabled:text-gray-500 disabled:cursor-not-allowed"><span class="material-symbols-outlined text-2xl">undo</span></button>
                        <button id="redo-btn" class="btn rounded-full w-10 h-10 flex items-center justify-center transition-colors bg-teal-600 hover:bg-teal-500 disabled:bg-gray-800 disabled:text-gray-500 disabled:cursor-not-allowed"><span class="material-symbols-outlined text-2xl">redo</span></button>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-bold mb-2 flex items-center">
                            ã“ã“ã‚’ä¿®æ­£ã—ã¦ï¼
                            <div class="ml-4 flex items-center">
                                <label for="customTranslateSwitch" class="text-sm font-normal text-gray-400 mr-2">ï¼ˆè‡ªç”±ã«ä¿®æ­£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ï¼‰ è‡ªå‹•ç¿»è¨³:</label>
                                <input type="checkbox" id="customTranslateSwitch" class="form-checkbox h-4 w-4 text-gray-400 border-gray-400 transition duration-150 ease-in-out" checked>
                            </div>
                        </h3>
                        <div class="flex items-center gap-2">
                            <textarea id="custom-fix-prompt" rows="1" class="w-full p-3 bg-gray-800 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-900 disabled:text-gray-500" placeholder="ä¾‹ï¼šæœã‚’åˆ¥ã®è‰²ã«å¤‰ãˆã¦ã€ãƒãƒ¼ã‚ºã‚’å¤‰ãˆã¦"></textarea>
                            <button id="apply-custom-btn" class="p-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="scroll-to-top-btn" class="p-3 bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 rounded-full shadow-lg">
        <span class="material-symbols-outlined">arrow_upward</span>
    </button>

    <script>
        /* Copyright (c) 2025-2026 ã­ãŠã‚“ / Licensed under PolyForm Noncommercial 1.0.0 (https://polyformproject.org/licenses/noncommercial/1.0.0/) */
        const APP_VERSION = '6.5';

        document.title = `ğŸ¥ ãƒ•ã‚£ã‚®ãƒ¥ã‚¢åŒ–ãƒ¡ãƒ¼ã‚«ãƒ¼ v${APP_VERSION}`;
        const appVersionSpan = document.getElementById('app-version');
        appVersionSpan.textContent = `v${APP_VERSION}`;

        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                fileInput: document.getElementById('file-input'),
                dropZone: document.getElementById('drop-zone'),
                imagePreview: document.getElementById('image-preview'),
                dropText: document.getElementById('drop-text'),
                additionalPrompt: document.getElementById('additional-prompt'),
                additionalNegativePrompt: document.getElementById('additional-negative-prompt'),
                autoTranslateSwitch: document.getElementById('autoTranslateSwitch'),
                customTranslateSwitch: document.getElementById('customTranslateSwitch'),
                generateBtn: document.getElementById('generate-btn'),
                loading: document.getElementById('loading'),
                loadingText: document.getElementById('loading-text'),
                loadingAnimation: document.getElementById('loading-animation'),
                outputSection: document.getElementById('output-section'),
                resultContainer: document.getElementById('result-container'),
                generatedImage: document.getElementById('generated-image'),
                copyrightWarning: document.getElementById('copyright-warning'),
                downloadBtn: document.getElementById('download-btn'),
                copyAllPromptsBtn: document.getElementById('copy-all-prompts-btn'),
                promptOutputTooltip: document.getElementById('prompt-output-tooltip'),
                errorMessage: document.getElementById('error-message'),
                scrollToTopBtn: document.getElementById('scroll-to-top-btn'),
                infoBtn: document.getElementById('info-btn'),
                infoTooltip: document.getElementById('info-tooltip'),
                licenseBtn: document.getElementById('license-btn'),
                licenseTooltip: document.getElementById('license-tooltip'),
                toggleSizeBtn: document.getElementById('toggle-size-btn'),
                toggleSizeIcon: document.getElementById('toggle-size-icon'),
                resetPromptsButton: document.getElementById('reset-prompts-button'),
                modeSelect: document.getElementById('mode-select'),
                typeSelect: document.getElementById('type-select'),
                packageSelect: document.getElementById('package-select'),
                locationSelect: document.getElementById('location-select'),
                standSelect: document.getElementById('stand-select'),
                aspectRatioSelect: document.getElementById('aspect-ratio-select'),
                actionArea: document.getElementById('action-area'),
                fixLogoBtn: document.getElementById('fix-logo-btn'),
                fixCloseupBtn: document.getElementById('fix-closeup-btn'),
                furtherFigureBtn: document.getElementById('further-figure-btn'),
                undoBtn: document.getElementById('undo-btn'),
                redoBtn: document.getElementById('redo-btn'),
                customFixPrompt: document.getElementById('custom-fix-prompt'),
                applyCustomBtn: document.getElementById('apply-custom-btn'),
                imageLoadingOverlay: document.getElementById('image-loading-overlay'),
                imageLoadingAnimation: document.getElementById('image-loading-animation'),
                imageLoadingText: document.getElementById('image-loading-text'),
                flipImageBtn: document.getElementById('flip-image-btn'),
                multiGenerateToggle: document.getElementById('multi-generate-toggle'),
            };

            let toastTimeoutId = null;      // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
            let licenseTimeout;
            const MAX_HISTORY_SIZE = 20; // æœ€å¤§å±¥æ­´æ•°
            let uploadedImageData = null, isContainMode = false;
            let uploadedImageMimeType = '';
            let lastPositivePrompt = '', lastNegativePrompt = '';
            let generationLog = [];
            let imageHistory = [];
            let currentImageIndex = -1;
            let cachedSubjectType = null;
            let cachedPromptTranslation = {};
            let cachedNegativePromptTranslation = {};
            const handleShiftEnter = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Enterã‚­ãƒ¼ã«ã‚ˆã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œï¼ˆæ”¹è¡Œãªã©ï¼‰ã‚’æŠ‘åˆ¶
                    handleGeneration();
                }
            };
            let currentImageData = null;
            let currentImagePrompt = '';
            let isClickToFixMode = false;
            let wasCopyrightWarningVisibleBeforeClickMode = false;
            let isImageFlipped = false;
            /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã®å®šç¾©ï¼ˆW:Hï¼‰
             * ratio.w / ratio.h ã§å®Ÿéš›ã®æ¯”ç‡ (float) ãŒå¾—ã‚‰ã‚Œã‚‹ã€‚ */
            const ASPECT_RATIO_MAP = {
                '1:1': { w: 1, h: 1, },
                '3:2': { w: 3, h: 2, },
                '2:3': { w: 2, h: 3, },
                '4:3': { w: 4, h: 3, },
                '3:4': { w: 3, h: 4, },
                '16:9': { w: 16, h: 9, },
                '9:16': { w: 9, h: 16, },
            };
            let isMultiGenerateEnabled = true;

            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            elements.dropZone.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', (e) => e.target.files[0] && processFile(e.target.files[0]));
            elements.dropZone.addEventListener('dragover', (e) => {
                e.preventDefault(); e.stopPropagation(); elements.dropZone.classList.add('border-blue-500');
            });
            elements.dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault(); e.stopPropagation(); elements.dropZone.classList.remove('border-blue-500');
            });
            elements.dropZone.addEventListener('drop', (e) => {
                e.preventDefault(); e.stopPropagation(); e.dataTransfer.files[0] && processFile(e.dataTransfer.files[0]);
            });
            elements.toggleSizeBtn.addEventListener('click', (e) => {
                e.stopPropagation(); isContainMode = !isContainMode; elements.imagePreview.classList.toggle('image-fit-contain'); elements.toggleSizeIcon.textContent = isContainMode ? 'zoom_out_map' : 'zoom_in_map';
            });
            elements.generateBtn.addEventListener('click', handleGeneration);
            elements.infoBtn.addEventListener('mouseenter', () => elements.infoTooltip.classList.remove('hidden'));
            elements.infoBtn.addEventListener('mouseleave', () => elements.infoTooltip.classList.add('hidden'));

            // è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const showTooltip = () => {
                clearTimeout(licenseTimeout);
                elements.licenseTooltip.classList.remove('hidden');
            };
            // éš ã™é–¢æ•°
            const hideTooltip = () => {
                licenseTimeout = setTimeout(() => {
                    elements.licenseTooltip.classList.add('hidden');
                }, 200); // 0.2ç§’ã®çŒ¶äºˆ
            };
            elements.licenseBtn.addEventListener('mouseenter', showTooltip);
            elements.licenseBtn.addEventListener('mouseleave', hideTooltip);
            elements.licenseTooltip.addEventListener('mouseenter', showTooltip);
            elements.licenseTooltip.addEventListener('mouseleave', hideTooltip);

            window.addEventListener('scroll', () => {
                window.scrollY > 200 ? elements.scrollToTopBtn.classList.add('visible') : elements.scrollToTopBtn.classList.remove('visible');
            });
            elements.scrollToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth', }));
            elements.downloadBtn.addEventListener('click', handleDownload);
            elements.copyAllPromptsBtn.addEventListener('click', () => copyToClipboard(`${lastPositivePrompt}\n${lastNegativePrompt}`, elements.copyAllPromptsBtn));
            elements.copyrightWarning.addEventListener('click', () => {
                elements.copyrightWarning.style.display = 'none';
            });
            elements.fixLogoBtn.addEventListener('click', () => handleFixImage('logo'));
            elements.fixCloseupBtn.addEventListener('click', () => handleFixImage('closeup'));
            elements.furtherFigureBtn.addEventListener('click', () => handleFixImage('enhance'));
            elements.undoBtn.addEventListener('click', undoImage);
            elements.redoBtn.addEventListener('click', redoImage);
            elements.applyCustomBtn.addEventListener('click', () => handleFixImage('custom'));
            elements.additionalPrompt.addEventListener('keydown', handleShiftEnter);
            elements.additionalNegativePrompt.addEventListener('keydown', handleShiftEnter);
            elements.additionalPrompt.addEventListener('input', updateResetButtonVisibility);
            elements.additionalNegativePrompt.addEventListener('input', updateResetButtonVisibility);
            elements.customFixPrompt.addEventListener('input', updateCustomButtonState);
            elements.customFixPrompt.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    elements.applyCustomBtn.click();
                }
            });

            const ACRYLIC_STAND_SETTINGS = {
                mode: 'basic',
                stand: 'a transparent acrylic base',
            };
            const BASIC_NO_BASE_SETTINGS = {
                mode: 'basic',
                stand: 'without a base',
            };
            const FULL_RESET_SETTINGS = {
                mode: 'basic',
                stand: 'without a base',
                package: 'no packaging box',
                location: '',
            };
            const AUTO_SETTINGS = {
                stand: ACRYLIC_STAND_SETTINGS,
                key: BASIC_NO_BASE_SETTINGS,
                toy: BASIC_NO_BASE_SETTINGS,
                cos: FULL_RESET_SETTINGS,
                ghibli: FULL_RESET_SETTINGS,
            };

            elements.typeSelect.addEventListener('change', (e) => {
                const selectedType = e.target.value;
                const settings = AUTO_SETTINGS[selectedType];

                if (settings) {
                    elements.modeSelect.value = settings.mode;
                    elements.standSelect.value = settings.stand;

                    // packageã¨locationã¯ã€è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ä¸Šæ›¸ãã•ã‚Œã‚‹
                    if (settings.package !== undefined) {
                        elements.packageSelect.value = settings.package;
                    }
                    if (settings.location !== undefined) {
                        elements.locationSelect.value = settings.location;
                    }
                }
            });

            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            elements.resetPromptsButton.addEventListener('click', (e) => {
                e.stopPropagation();
                elements.additionalPrompt.value = '';
                elements.additionalNegativePrompt.value = '';
                updateResetButtonVisibility();
            });

            // ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™ã‚’å–å¾—
            elements.imageLoadingOverlay.addEventListener('click', async (event) => {
                if (isClickToFixMode && currentImageData) {
                    try {
                        setImageLoadingState(true, 'åº§æ¨™ã‚’æŒ‡å®šã—ã¦ãƒ­ã‚´ã‚’ä¿®æ­£ä¸­...');
                        elements.imageLoadingOverlay.classList.remove('click-to-fix-cursor');
                        const rect = elements.imagePreview.getBoundingClientRect();
                        const clickX = event.clientX - rect.left;
                        const clickY = event.clientY - rect.top;

                        const nativeWidth = elements.generatedImage.naturalWidth;
                        const nativeHeight = elements.generatedImage.naturalHeight;
                        const displayedWidth = rect.width;
                        const displayedHeight = rect.height;

                        const scaledX = Math.round(clickX * (nativeWidth / displayedWidth));
                        const scaledY = Math.round(clickY * (nativeHeight / displayedHeight));

                        const logo_prompt = `A logo, brand name, trademark, or illegally generated copyrighted element is located around the coordinate (x=${scaledX}, y=${scaledY}).`;
                        const result = await checkAndFixCopyright(currentImageData, true, logo_prompt);

                        if (result.wasProblematic) {
                            updateImageHistory(result.base64Data, currentImagePrompt);
                        } else {
                            console.warn('[figureMaker] æŒ‡å®šç®‡æ‰€ã®ä¿®æ­£ã‚’è©¦ã¿ã¾ã—ãŸãŒã€ç”»åƒã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
                        }
                    } catch (error) {
                        console.error('[figureMaker] æŒ‡å®šç®‡æ‰€ã®ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    } finally {
                        handleFixImage('logo');
                    }
                }
            });

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®å·¦å³çŸ¢å°ã‚­ãƒ¼ã§Undo/Redo
            document.addEventListener('keydown', (e) => {
                // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ä¸­ã¯ã‚­ãƒ¼æ“ä½œã‚’ç„¡åŠ¹ã«ã™ã‚‹
                if (document.activeElement === elements.additionalPrompt ||
                    document.activeElement === elements.additionalNegativePrompt ||
                    document.activeElement === elements.customFixPrompt) {
                    return;
                }
                // ã‚¯ãƒªãƒƒã‚¯å¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã‹ã¤ESCã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸå ´åˆ
                if (e.key === 'Escape' && isClickToFixMode) {
                    e.preventDefault();
                    handleFixImage('logo');
                }
                if (e.key === 'ArrowLeft') {
                    // ã€Œâ†ã€ã‚­ãƒ¼ã§Undo: ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ãªæ™‚ã ã‘å®Ÿè¡Œ
                    if (!elements.undoBtn.disabled) {
                        undoImage();
                    }
                } else if (e.key === 'ArrowRight') {
                    // ã€Œâ†’ã€ã‚­ãƒ¼ã§Redo: ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ãªæ™‚ã ã‘å®Ÿè¡Œ
                    if (!elements.redoBtn.disabled) {
                        redoImage();
                    }
                }
            });

            // ã€å·¦å³åè»¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ ã€‘
            elements.flipImageBtn.addEventListener('click', () => {
                if (!uploadedImageData) {
                    return;
                }

                // çŠ¶æ…‹ã‚’åè»¢
                isImageFlipped = !isImageFlipped;

                // ç”»åƒè¦ç´ ã®ã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                const targetImage = elements.generatedImage;
                if (isImageFlipped) {
                    targetImage.classList.add('flipped');
                } else {
                    targetImage.classList.remove('flipped');
                }

                elements.flipImageBtn.classList.toggle('is-active', isImageFlipped);

                const DEFAULT_CLASSES = ['bg-gray-700', 'hover:bg-gray-600',];
                const ACTIVE_CLASSES = ['bg-orange-600', 'hover:bg-orange-500',];

                if (isImageFlipped) {
                    // åè»¢ã—ã¦ã„ã‚‹å ´åˆï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰
                    elements.flipImageBtn.classList.remove(...DEFAULT_CLASSES);
                    elements.flipImageBtn.classList.add(...ACTIVE_CLASSES);
                } else {
                    // åè»¢ã—ã¦ã„ãªã„å ´åˆï¼ˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰
                    elements.flipImageBtn.classList.remove(...ACTIVE_CLASSES);
                    elements.flipImageBtn.classList.add(...DEFAULT_CLASSES);
                }
            });

            elements.multiGenerateToggle.addEventListener('click', () => {
                isMultiGenerateEnabled = !isMultiGenerateEnabled;
                if (isMultiGenerateEnabled) {
                    elements.multiGenerateToggle.classList.remove('bg-gray-700', 'text-gray-400', 'hover:bg-gray-600');
                    elements.multiGenerateToggle.classList.add('bg-blue-500', 'hover:bg-blue-400', 'text-white', 'scale-105');
                } else {
                    elements.multiGenerateToggle.classList.remove('bg-blue-500', 'hover:bg-blue-400', 'text-white', 'scale-105');
                    elements.multiGenerateToggle.classList.add('bg-gray-700', 'text-gray-400', 'hover:bg-gray-600');
                }
            });

            updateActionButtonsState();
            updateResetButtonVisibility();
            updateCustomButtonState();

            function processFile(file) {
                if (!file.type.startsWith('image/')) {
                    return showError('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                }
                uploadedImageMimeType = file.type;
                const reader = new FileReader();
                reader.onload = (e) => {
                    elements.imagePreview.src = e.target.result;
                    elements.imagePreview.classList.remove('hidden');
                    elements.dropText.classList.add('hidden');
                    elements.toggleSizeBtn.classList.remove('hidden');
                    isContainMode = false;
                    elements.imagePreview.classList.remove('image-fit-contain');
                    elements.toggleSizeIcon.textContent = 'zoom_in_map';
                    uploadedImageData = e.target.result.split(',')[1];
                    cachedSubjectType = null;
                };
                reader.readAsDataURL(file);
            }

            // APIã‚’å©ãæœ¬ä½“
            async function callGeminiAPI(payload) {
                const apiKey = "";
                const model = payload.contents[0].parts.some(p => p.inlineData)
                    ? 'gemini-2.5-flash-image-preview'    // ç”»åƒå«ã‚€ãªã‚‰ç”»åƒãƒ¢ãƒ‡ãƒ«
                    : 'gemini-2.5-flash-preview-09-2025'; // ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ãªã‚‰ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify(payload), });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const status = response.status;
                    const message = errorData.error?.message || 'ä¸æ˜ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼';
                    let userMsg = `APIã‚¨ãƒ©ãƒ¼ (ã‚³ãƒ¼ãƒ‰: ${status})ã€‚\n`;

                    if (message.includes('SAFETY')) {
                        userMsg += "ä¸é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨åˆ¤æ–­ã•ã‚ŒãŸãŸã‚ã€ç”»åƒã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
                    } else if (status === 400) {
                        userMsg += "ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒä¸é©åˆ‡ã€ãªã©ï¼‰ã€‚";
                    } else if (status === 429) {
                        userMsg += "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
                    } else {
                        userMsg += `ã‚µãƒ¼ãƒãƒ¼å¿œç­”: ${message}`;
                    }
                    throw new Error(userMsg);
                }
                return await response.json();
            }

            async function analyzeImageForCopyright(imageData) {
                const prompt = `Analyze the image only for logos or copyrighted text. If found, describe the location and the item it is on, using concise English. For example: "Logo on the bottom-right package corner" or "Brand name on the central figure's base". If no issue is found, respond with ONLY the word 'NONE'.`;
                const payload = {
                    contents: [{ parts: [
                        { text: prompt, },
                        { inlineData: { mimeType: 'image/jpeg', data: imageData, }, },
                    ], },],
                    generationConfig: { responseModalities: ['TEXT',], },
                };
                try {
                    const result = await callGeminiAPI(payload); // callGeminiAPIãŒ gemini-2.5-flash ã‚’é¸æŠã™ã‚‹
                    const answer = result.candidates[0].content.parts[0].text.trim();
                    return answer.toUpperCase() === 'NONE' ? null : answer;
                } catch (error) {
                    console.error('[figureMaker] Copyright check failed:', error);
                    return null;
                }
            }

            // è‘—ä½œæ¨©ä¿è­·å¯¾è±¡ã‚’ä¿®æ­£ã™ã‚‹é–¢æ•°
            async function checkAndFixCopyright(base64Data, isImageFixing = false, logoLocationHint = null) {
                /* Natural Inpainting Command: Remove the watermark, text, or logo from the specific area of Image 1 and naturally fill the space with seamless, contextually appropriate background details. The output must be perfectly consistent with the surrounding image texture and style. */
                let prompt = `Your task is a precision inpainting process to clean and refine the image.
                        MODIFICATION GUIDELINES:
                        1. The subject's pose, face, and the core figure's appearance must be preserved.
                        2. The rest of the image should remain unchanged, except for the specific area being repaired.
                        3. The ultimate goal is to achieve a professional, clean product by seamlessly removing unwanted elements.`;
                if (logoLocationHint) {
                    /* ãƒ­ã‚´ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ (ã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒ†ã‚£ãƒ³ã‚°) */
                    prompt += `
                        INPAINTING INSTRUCTION: A specific element (logo, text, or trademark) must be removed from the area described below.
                        Target Location Hint: "${logoLocationHint}"
                        ACTION REQUIRED: Eliminate the visibility of this unwanted element. Perform a highly localized, seamless reconstruction to fill the removed area. The repaired area must be completely unbranded and perfectly integrated with the surrounding background and texture. Focus solely on the removal and repair; preserve the overall composition and style.
                        AVOIDANCE: Do not change the subject's pose or core appearance. Do not simply blur or roughen the texture. Repair must be seamless.`;
                } else {
                    /* å¾“æ¥ã®è‡ªå‹•è‘—ä½œæ¨©ãƒã‚§ãƒƒã‚¯ æ±ç”¨çš„ãªæ¬ é™¥ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ */
                    prompt += `
                        Analyze the image for minor inconsistencies, graphical elements, or small rendering flaws. If any flaws are detected, modify ONLY the problematic area using high-quality inpainting. Seamlessly blend the repaired area to match the surrounding environment, preserving the artistic integrity of the image.`;
                }
                const payload = {
                    contents: [{ parts: [
                        { text: prompt, },
                        { inlineData: { mimeType: 'image/jpeg', data: base64Data, }, },
                    ], },],
                    safetySettings: [{ category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE", },],
                    generationConfig: { responseModalities: ['TEXT', 'IMAGE',], },
                };

                const loadingMsg = isImageFixing ? 'ãƒ­ã‚´ä¿®æ­£ä¸­' : 'è‘—ä½œæ¨©ãƒã‚§ãƒƒã‚¯ä¸­';
                let finalData = await generateImageWithRetry(payload, 6, loadingMsg, true);

                // æˆ»ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒå…ƒã®ãƒ‡ãƒ¼ã‚¿ã¨ç•°ãªã‚Œã°ï¼ˆ=ä¿®æ­£ãŒè¡Œã‚ã‚Œã¦ã„ã‚Œã°ï¼‰ã€wasProblematic=trueã¨ã™ã‚‹
                const wasProblematic = (finalData !== base64Data);
                return { base64Data: finalData, wasProblematic: wasProblematic, };
            }

            /**
             * é¸æŠã•ã‚ŒãŸã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã¨ç¾åœ¨ã®ã‚µã‚¤ã‚ºã«åŸºã¥ãã€æ–°ã—ã„ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã‚’å‹•çš„ã«è¨ˆç®—ã™ã‚‹ã€‚
             * æœ€å°/æœ€å¤§å€¤ã®åˆ¶é™ï¼ˆã‚¯ãƒ©ãƒ³ãƒ”ãƒ³ã‚°ï¼‰ã‚’é©ç”¨ã™ã‚‹ã€‚ï¼ˆW >= 512, H >= 512, W <= 2048, H <= 2048 ã‚’ä¿è¨¼ï¼‰
             * @param {string} ratioStr - é¸æŠã•ã‚ŒãŸã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ï¼ˆä¾‹: '3:4'ï¼‰
             * @param {number} currentWidth - ç¾åœ¨ã®ç”Ÿæˆå¹… (W)
             * @param {number} currentHeight - ç¾åœ¨ã®ç”Ÿæˆé«˜ã• (H)
             * @returns {{width: number, height: number}} - è¨ˆç®—ã•ã‚ŒãŸæ–°ã—ã„ã‚µã‚¤ã‚º
             */
            function calculateDimensions(ratioStr, currentWidth, currentHeight) {
                if (ratioStr === 'auto' || !ASPECT_RATIO_MAP[ratioStr]) {
                    return { width: currentWidth, height: currentHeight, };
                }

                const MIN_SIZE = 512;
                const MAX_SIZE = 2048; // APIã®åˆ¶é™ã«åŸºã¥ãè¨­å®š

                const ratio = ASPECT_RATIO_MAP[ratioStr];
                let newWidth, newHeight;

                // 1. ç¾åœ¨ã®æœ€ã‚‚é•·ã„è¾ºã‚’æ–°ã—ã„ã‚µã‚¤ã‚ºã®åŸºæº–ã¨ã™ã‚‹
                let BASE_RESOLUTION = Math.max(currentWidth, currentHeight);

                // 2. å¢ƒç•Œå‡¦ç† (ã‚¯ãƒ©ãƒ³ãƒ”ãƒ³ã‚°) - æœ€å¤§å€¤ã®åˆ¶é™ï¼ˆåˆæœŸå€¤ãŒå¤§ãã™ãã‚‹å ´åˆï¼‰
                if (BASE_RESOLUTION > MAX_SIZE) {
                    BASE_RESOLUTION = MAX_SIZE; // å¤§ãã™ãã‚‹å ´åˆã¯æœ€å¤§å€¤ã«åˆ¶é™
                }

                // 3. ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã«åŸºã¥ãæš«å®šçš„ãªè¨ˆç®—
                if (ratio.w > ratio.h) {
                    // æ¨ªé•·ã®å ´åˆ (ä¾‹: 4:3) -> å¹…(w)ãŒé•·ã„
                    newWidth = BASE_RESOLUTION;
                    newHeight = Math.round(BASE_RESOLUTION * (ratio.h / ratio.w));
                } else {
                    // ç¸¦é•·ã¾ãŸã¯æ­£æ–¹å½¢ã®å ´åˆ (ä¾‹: 3:4, 1:1) -> é«˜ã•(h)ãŒé•·ã„ï¼ˆã¾ãŸã¯ç­‰ã—ã„ï¼‰
                    newHeight = BASE_RESOLUTION;
                    newWidth = Math.round(BASE_RESOLUTION * (ratio.w / ratio.h));
                }

                // 4. å¢ƒç•Œå‡¦ç† (ã‚¯ãƒ©ãƒ³ãƒ”ãƒ³ã‚°) - æœ€å°å€¤ã®ä¿è¨¼ (çŸ­ã„è¾ºãŒ512ã‚’ä¸‹å›ã‚‹å ´åˆã®å†è¨ˆç®—)
                if (newWidth < MIN_SIZE || newHeight < MIN_SIZE) {
                    // çŸ­ã„æ–¹ã®è¾ºãŒ MIN_SIZE ã‚’ä¸‹å›ã£ãŸå ´åˆã€çŸ­ã„æ–¹ã‚’ MIN_SIZE ã«å›ºå®šã—ã¦æ‹¡å¤§ã™ã‚‹
                    if (ratio.w < ratio.h) {
                        // ç¸¦é•·ã®å ´åˆ: å¹…(w)ãŒçŸ­ã„
                        newWidth = MIN_SIZE;
                        newHeight = Math.round(MIN_SIZE * (ratio.h / ratio.w));
                    } else if (ratio.h < ratio.w) {
                        // æ¨ªé•·ã®å ´åˆ: é«˜ã•(h)ãŒçŸ­ã„
                        newHeight = MIN_SIZE;
                        newWidth = Math.round(MIN_SIZE * (ratio.w / ratio.h));
                    } else {
                        // æ­£æ–¹å½¢ã®å ´åˆ: W=H=512
                        newWidth = MIN_SIZE;
                        newHeight = MIN_SIZE;
                    }
                }

                // 5. å¢ƒç•Œå‡¦ç† (ã‚¯ãƒ©ãƒ³ãƒ”ãƒ³ã‚°) - æœ€å¤§å€¤ã®æœ€è¨¼
                // æœ€å°å€¤å‡¦ç†(Step 4)ã«ã‚ˆã£ã¦ã‚µã‚¤ã‚ºãŒæ‹¡å¤§ã•ã‚Œã€MAX_SIZEã‚’è¶…ãˆãŸå ´åˆã«å‚™ãˆã‚‹ã€‚
                if (newWidth > MAX_SIZE || newHeight > MAX_SIZE) {
                    // é•·ã„æ–¹ã®è¾ºãŒ MAX_SIZE ã‚’è¶…ãˆãŸå ´åˆã€é•·ã„æ–¹ã‚’ MAX_SIZE ã«å›ºå®šã—ã¦ç¸®å°ã™ã‚‹
                    if (ratio.w > ratio.h) {
                        // æ¨ªé•·ã®å ´åˆ: å¹…(w)ãŒé•·ã„
                        newWidth = MAX_SIZE;
                        newHeight = Math.round(MAX_SIZE * (ratio.h / ratio.w));
                    } else if (ratio.h > ratio.w) {
                        // ç¸¦é•·ã®å ´åˆ: é«˜ã•(h)ãŒé•·ã„
                        newHeight = MAX_SIZE;
                        newWidth = Math.round(MAX_SIZE * (ratio.w / ratio.h));
                    } else {
                        // æ­£æ–¹å½¢ã®å ´åˆ: W=H=MAX_SIZE
                        newWidth = MAX_SIZE;
                        newHeight = MAX_SIZE;
                    }
                }

                return { width: newWidth, height: newHeight, };
            }

            /**
             * æŒ‡å®šã•ã‚ŒãŸwidthã¨heightã‚’æŒã¤ã€å®Œå…¨ã«é€æ˜ãªPNGç”»åƒã‚’Base64å½¢å¼ã§ç”Ÿæˆã—ã¾ã™ã€‚
             * Canvas APIã‚’ä½¿ç”¨ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒå®Œå…¨ã«æœ‰åŠ¹ãªPNGã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚
             * @param {number} width - å¿…è¦ãªç”»åƒã®å¹… (ãƒ”ã‚¯ã‚»ãƒ«)
             * @param {number} height - å¿…è¦ãªç”»åƒã®é«˜ã• (ãƒ”ã‚¯ã‚»ãƒ«)
             * @returns {string | null} Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸé€æ˜PNGã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã€ã¾ãŸã¯nullï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
             */
            function generateTransparentBase64(width, height) {
                // 1. Canvasè¦ç´ ã‚’ä½œæˆã—ã€ã‚µã‚¤ã‚ºã‚’è¨­å®š
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;

                // 2. å®Œå…¨ã«é€æ˜ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
                const ctx = canvas.getContext('2d');

                // 3. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é€æ˜ï¼‰
                ctx.clearRect(0, 0, width, height);

                // 4. Base64æ–‡å­—åˆ—ã‚’å–å¾—ã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã‚’é™¤å»
                // toDataURL()ã¯ "data:image/png;base64," ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿”ã™
                try {
                    const dataUrl = canvas.toDataURL('image/png');
                    const base64Prefix = 'data:image/png;base64,';

                    if (dataUrl.startsWith(base64Prefix)) {
                        return dataUrl.substring(base64Prefix.length);
                    } else {
                        // PNGå½¢å¼ã§Base64ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼
                        console.error("[figureMaker] Canvas toDataURL failed to return PNG format.");
                        return null;
                    }
                } catch (e) {
                    console.error("[figureMaker] Canvas Base64 generation failed:", e);
                    return null;
                }
            }

            // è¢«å†™ä½“åˆ¤å®š
            async function detectSubject(imageData) {
                const payload = { contents: [{ parts: [{ text: "Analyze the main subject of this image. Choose only one from 'person', 'animal', 'food', 'object', 'landscape', or 'other' if none apply. Respond with only one category name in English.", }, { inlineData: { mimeType: 'image/jpeg', data: imageData, }, },], },], };
                try {
                    const result = await callGeminiAPI(payload);
                    if (!result || !result.candidates || result.candidates.length === 0) {
                        throw new Error('è¢«å†™ä½“åˆ¤å®šä¸­ã«APIãŒç©ºã®å¿œç­”ã‚’è¿”ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å®‰å…¨ãƒãƒªã‚·ãƒ¼ã«é•åã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                    }
                    const detected = result.candidates[0].content.parts[0].text.trim().toLowerCase();
                    const subjectMap = { person: 'äººç‰©', animal: 'å‹•ç‰©', food: 'é£Ÿã¹ç‰©', object: 'ãƒ¢ãƒ', landscape: 'é¢¨æ™¯', };
                    return Object.keys(subjectMap).find(key => detected.includes(key)) || 'subject';
                } catch (error) {
                    throw new Error('è¢«å†™ä½“ã®è‡ªå‹•åˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚å®‰å…¨ãƒãƒªã‚·ãƒ¼é•åã‚„APIé€šä¿¡ã®å•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                }
            }

            // ç¿»è¨³
            async function translateText(text, stage) {
                let useSwitch;
                let isCustomFix = false;
                if (stage === 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¿»è¨³ä¸­(Positive)...' || stage === 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¿»è¨³ä¸­(Negative)...') {
                    useSwitch = elements.autoTranslateSwitch;
                } else if (stage === 'ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºã‚’ç¿»è¨³ä¸­...') {
                    useSwitch = elements.customTranslateSwitch;
                    isCustomFix = true;
                } else {
                    console.warn(`[figureMaker] ä¸æ˜ãªç¿»è¨³ã‚¹ãƒ†ãƒ¼ã‚¸ãŒæ¸¡ã•ã‚Œã¾ã—ãŸ: ${stage}`);
                    return text;
                }
                if (useSwitch && !useSwitch.checked) {
                    console.log(`[figureMaker] è‡ªå‹•ç¿»è¨³ãŒOFFã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ (Stage: ${stage})ã€‚`);
                    return text;
                }

                // æ—¥æœ¬èªã‚’å«ã¾ãªã„ãªã‚‰ã€APIã‚³ãƒ¼ãƒ«ã‚’ã›ãšãã®ã¾ã¾è¿”ã™
                if (!text || !/[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/.test(text)) {
                    return text;
                }

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‡¦ç†
                const cacheKey = text;
                let cacheMap = stage.includes('Negative') ? cachedNegativePromptTranslation : cachedPromptTranslation;

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã§ããŸã®ã§ã€APIã‚³ãƒ¼ãƒ«ã¯ã‚¼ãƒ­ï¼
                if (cacheMap[cacheKey]) {
                    return cacheMap[cacheKey];
                }

                updateLoadingText(stage);
                if (!elements.imageLoadingOverlay.classList.contains('hidden')) {
                    elements.imageLoadingText.textContent = stage;
                }

                const instruction = "Translate the following Japanese text to English for an image generation prompt. Keep the nuances and output only the translated text. Do not translate any proper nouns or brand names (e.g., PokÃ©mon, Nike); retain the original spelling."
                    + (isCustomFix ? " This is for a custom fix/adjustment prompt." : "");
                const payload = { contents: [{ parts: [{ text: `${instruction} Text to translate: "${text}"`, },], },], };
                try {
                    const result = await callGeminiAPI(payload);
                    const translatedText = result.candidates[0].content.parts[0].text.trim();
                    cacheMap[cacheKey] = translatedText; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                    return translatedText;
                } catch (error) {
                    console.error('[figureMaker] Translation failed:', error);
                    showError('ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                    return text;
                }
            }

            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ„ç«‹
            function buildPrompts(subjectType) {
                const mode = elements.modeSelect.value;
                const type = elements.typeSelect.value;
                const location = elements.locationSelect.value;
                const stand = elements.standSelect.value;
                const packageVal = elements.packageSelect.value;

                const typePrompts = {
                    pvc: 'PVC plastic figure, realistic painted surface, detailed shading, light reflections, glossy highlights, matte finish on skin, subtle seam lines as seen in real manufactured figures',
                    nendoroid: 'Nendoroid figure, big head, chibi style, matte painted surface, smooth texture',
                    clay: 'clay figure, handmade texture, sculpted by an artist, fingerprint marks, clay surface',
                    stand: 'acrylic stand figure, laser cut, sharp focus on clear plastic edges, glossy surface, transparent material, photorealistic product shot',
                    key: 'acrylic keychain figure, visible keyring attachment, metal split ring, sharp focus on clear plastic edges, (no stand:1.5), hanging',
                    toy: 'plush toy, soft fabric texture, cotton filling, felt material, detailed embroidery, realistic stitching, cute, fluffy, professional product photography',
                    cos: 'photobook-style, real life, real human, hyper detailed, detailed skin texture, natural lighting, realistic photo of a beautiful girl cosplayer, dressed in the costume of the character in this image, professional quality, high detail, outdoor photography, shallow depth of field',
                    ghibli: '((Studio Ghibli style anime illustration:1.5)), anime style, (hand-drawn 2D animation:1.5), (soft pastel colors:1.2), gentle color palette, clear outlines, expressive character design, beautiful background art, nostalgic and heartwarming atmosphere, (no photorealism:1.5), (no 3D:1.5)',
                };

                const realismBoostMap = {
                    'with a futuristic cityscape background': 'photorealistic, cinematic, detailed lighting, volumetric fog, high-resolution textures, shallow depth of field, professional product photography',
                    'marin blue sea and white sandy beach background': 'photograph, macro lens, professional photography, realistic texture, no cartoon or anime style, shallow depth of field',
                    'in a cozy and detailed bedroom background': 'photorealistic, detailed and realistic, sharp focus, professional product photography, shallow depth of field',
                    'on a simple white background': 'professional studio lighting, smooth studio background, sharp focus, shallow depth of field',
                    'on a wooden table with soft lighting': 'professional studio lighting, realistic wood texture, soft natural light, shallow depth of field',
                    'in a glass showcase': 'realistic glass reflection, detailed lighting, professional product photography, shallow depth of field',
                    '': 'detailed and realistic, sharp focus, professional product photography, shallow depth of field',
                };

                let basePrompt = '';
                let negativePromptParts = [];
                let realismBoostPrompt = realismBoostMap[location] || '';

                switch(mode) {
                case 'basic':
                    if (type === 'cos') {
                        // ã‚³ã‚¹ãƒ—ãƒ¬ã®å ´åˆ: ãƒ•ã‚£ã‚®ãƒ¥ã‚¢åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ’é™¤
                        basePrompt = `Create a photorealistic image of a ${typePrompts[type]} based on the subject in this image.`;
                    } else if (type === 'ghibli') {
                        // ã‚¸ãƒ–ãƒªé¢¨ã®å ´åˆ: ãƒ•ã‚©ãƒˆãƒªã‚¢ãƒ«ã¨ãƒ•ã‚£ã‚®ãƒ¥ã‚¢åŒ–ã®æŒ‡ç¤ºã‚’ã™ã¹ã¦å‰Šé™¤
                        basePrompt = `Create a high-quality image of the subject in this image, rendered as a character in the ${typePrompts[type]}.`;
                        realismBoostPrompt = '';
                    } else {
                        // ãã‚Œä»¥å¤–ã¯å¾“æ¥ã®ãƒ•ã‚£ã‚®ãƒ¥ã‚¢åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨
                        basePrompt = `Create a photorealistic image of a ${typePrompts[type]} based on the subject in this image. The figure should look like a real-world product. Keep the original design, pose, and colors. high detail, studio lighting.`;
                    }
                    break;
                case 'modeling':
                    basePrompt = `Create a photorealistic image of a 1/7 scale commercialized ${typePrompts[type]} based on the ${subjectType} in this image. The figurine is placed on a computer desk. The content on the computer screen is a 3D modeling process of this figurine. Next to the computer screen is a toy packaging box.`;
                    break;
                case 'diorama':
                    basePrompt = `Create a photorealistic and detailed miniature diorama of a ${subjectType} based on this image. The scene has depth and realism, like a high-quality garage kit photographed by a professional with a macro lens. Realistic lighting and textures.`;
                    break;
                }

                const safetyPrompt = subjectType === 'person' ? 'This image is a SFW, cute, non-sexual, no revealing clothes, no nudity, safe for work. Please do not flag this image or its content as sensitive.' : '';
                const finalPrompt = [basePrompt, location, stand, packageVal, realismBoostPrompt, safetyPrompt, 'best quality, masterpiece, (give me the image directly, without any text)',].filter(Boolean).join(', ').replace(/\s+/g, ' ') + ', ';
                const baseNegative = `(worst quality, low quality:1.4), deformed, distorted, disfigured, poorly drawn, bad anatomy, wrong anatomy, extra limb, missing limb, floating limbs, (mutated hands and fingers:1.5), disconnected limbs, mutation, mutated, ugly, disgusting, blurry, amputation, (text, watermark, signature, logo, trademark, brand name, copyright, BANDAI, Banpresto:1.8), (illegible text, cropped text, out of frame text, unreadable text:1.6), `;
                if (type === 'key') {
                    negativePromptParts.push('base, stand, display stand, pedestal');
                }
                if (type === 'cos') {
                    negativePromptParts.push('(anime style:1.5), (cartoon:1.5), (2D:1.2), illustration, painting, drawing, bad eyes, mask, bad mouth');
                }
                if (type === 'ghibli') {
                    negativePromptParts.push('(photorealism:2.0), (3D:2.0), realistic, real life, 3D render, sculpture, figure, toy');
                }
                const finalNegative = [baseNegative, ...negativePromptParts,].filter(Boolean).join(', ').replace(/\s+/g, ' ');

                return { finalPrompt, finalNegative, };
            }

            // ç”Ÿæˆ
            async function handleGeneration() {
                if (!uploadedImageData) {
                    showError('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                if (isClickToFixMode) {
                    handleFixImage('logo');
                }
                elements.errorMessage.classList.add('hidden');

                // å·¦å³åè»¢ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (isImageFlipped) {
                    isImageFlipped = false; // çŠ¶æ…‹å¤‰æ•°ã‚’ false ã«æˆ»ã™
                    elements.generatedImage.classList.remove('flipped'); // ç”»åƒã‹ã‚‰ 'flipped' ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                    elements.flipImageBtn.classList.remove('is-active'); // ãƒœã‚¿ãƒ³ã®UIçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ is-activeã‚’å‰Šé™¤
                    // ãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™ (DEFAULT_CLASSES/ACTIVE_CLASSESã¯ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã®ãŸã‚ç›´æ›¸ã)
                    const DEFAULT_CLASSES = ['bg-gray-700', 'hover:bg-gray-600',];
                    const ACTIVE_CLASSES = ['bg-orange-600', 'hover:bg-orange-500',];
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè‰²ã‚’å‰Šé™¤ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰²ã‚’è¿½åŠ 
                    elements.flipImageBtn.classList.remove(...ACTIVE_CLASSES);
                    elements.flipImageBtn.classList.add(...DEFAULT_CLASSES);
                }

                setLoadingState(true, 'è¢«å†™ä½“ã‚’åˆ¤å®šä¸­...');
                try {
                    let subjectType;
                    if (cachedSubjectType) {
                        subjectType = cachedSubjectType;
                        updateLoadingText('è¢«å†™ä½“ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã—ã¾ã—ãŸã€‚');
                    } else {
                        subjectType = await detectSubject(uploadedImageData);
                        cachedSubjectType = subjectType;
                    }

                    // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã®æ±ºå®šã¨ãƒ€ãƒŸãƒ¼ç”»åƒã®ç”Ÿæˆ
                    const selectedRatio = elements.aspectRatioSelect.value;
                    // imagePreviewè¦ç´ ã‹ã‚‰ç¾åœ¨ã®å¹…/é«˜ã•ã‚’å–å¾—
                    let currentWidth = elements.imagePreview.naturalWidth || 1024;
                    let currentHeight = elements.imagePreview.naturalHeight || 1024;

                    const newDimensions = calculateDimensions(selectedRatio, currentWidth, currentHeight);
                    currentWidth = newDimensions.width;
                    currentHeight = newDimensions.height;

                    const customRatio = selectedRatio !== 'auto';
                    let ratioBase64 = null;
                    let aspectRatioPrompt = '';

                    if (customRatio) {
                        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã®ã¿ã€ç®—å‡ºã•ã‚ŒãŸã‚µã‚¤ã‚ºã§é€æ˜ç”»åƒã‚’ç”Ÿæˆ
                        ratioBase64 = generateTransparentBase64(currentWidth, currentHeight);
                        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¤‰æ›´ã®ãŸã‚ã®ç‰¹æ®ŠæŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
                        aspectRatioPrompt = `Expand the canvas of Image 1 to show more of the scene around the edges. Use Image 2 as the aspect ratio reference.`;
                    }

                    const [translatedPrompt, translatedNegative,] = await Promise.all([
                        translateText(elements.additionalPrompt.value.trim(), 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¿»è¨³ä¸­(Positive)...'),
                        translateText(elements.additionalNegativePrompt.value.trim(), 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¿»è¨³ä¸­(Negative)...'),
                    ]);

                    updateLoadingText('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ä¸­...');
                    let { finalPrompt, finalNegative, } = buildPrompts(subjectType);
                    const combinedPrompt = [aspectRatioPrompt, finalPrompt, translatedPrompt,].filter(Boolean).join(', ');
                    const combinedNegative = [finalNegative, translatedNegative,].filter(Boolean).join(', ');

                    lastPositivePrompt = combinedPrompt;
                    lastNegativePrompt = `Negative Prompt: ${combinedNegative}`;
                    elements.promptOutputTooltip.textContent = `${lastPositivePrompt}\n${lastNegativePrompt}`;

                    // --- APIãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã® contents ã«ãƒ€ãƒŸãƒ¼ç”»åƒã‚’æŒ¿å…¥ ---
                    const partsArray = [];
                    // å…ƒç”»åƒ (1æšç›®/å†…å®¹)
                    partsArray.push({ inlineData: { mimeType: uploadedImageMimeType, data: uploadedImageData, }, });
                    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (çœŸã‚“ä¸­)
                    partsArray.push({
                        text: `${aspectRatioPrompt} ${finalPrompt} ${translatedPrompt} | Negative Prompt: ${combinedNegative}`,
                    });
                    // ãƒ€ãƒŸãƒ¼ç”»åƒï¼ˆImage 2/ã‚µã‚¤ã‚ºï¼‰ã‚’æœ€å¾Œã«æŒ¿å…¥
                    if (ratioBase64) {
                        // ãƒ€ãƒŸãƒ¼ç”»åƒ (2æšç›®/ã‚µã‚¤ã‚ºæŒ‡å®š)
                        partsArray.push({
                            inlineData: { mimeType: 'image/png', data: ratioBase64, },
                        });
                    }

                    const initialPayload = {
                        contents: [{ parts: partsArray, },],
                        safetySettings: [{ category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE", },],
                        generationConfig: { responseModalities: ['TEXT', 'IMAGE',], },
                    };

                    let finalBase64Data = await generateImageWithRetry(initialPayload, 6, 'ç”»åƒã‚’ç”Ÿæˆä¸­', false);

                    setLoadingState(false);

                    const selectedPackage = elements.packageSelect.value;
                    let result = { base64Data: finalBase64Data, wasProblematic: false, };

                    if (selectedPackage !== 'no packaging box' && selectedPackage !== '') {
                        if (finalBase64Data) {
                            updateImageHistory(finalBase64Data, '');
                        }
                        try {
                            setImageLoadingState(true);
                            elements.imageLoadingText.textContent = 'è‘—ä½œæ¨©ãƒã‚§ãƒƒã‚¯ä¸­...';
                            const logoLocationHint = await analyzeImageForCopyright(finalBase64Data);

                            if (logoLocationHint) {
                                result = await checkAndFixCopyright(finalBase64Data, true, logoLocationHint);
                            } else {
                                console.log('[figureMaker] ç”Ÿæˆç”»åƒ:ãƒ­ã‚´ãªã—ã€‚è‡ªå‹•ä¿®æ­£ã‚’ã‚¹ã‚­ãƒƒãƒ—ã€‚');
                                result = { base64Data:finalBase64Data, wasProblematic:false, };
                            }
                        } catch (error) {
                            console.error('[figureMaker] è‡ªå‹•ä¿®æ­£ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                            throw error;
                        } finally {
                            setImageLoadingState(false);
                        }
                    }

                    finalBase64Data = result.base64Data;

                    if (result.wasProblematic) {
                        elements.copyrightWarning.classList.remove('hidden');
                    } else {
                        elements.copyrightWarning.classList.add('hidden');
                    }

                    if (finalBase64Data) {
                        updateImageHistory(finalBase64Data, '');
                    } else {
                        throw new Error('æœ€çµ‚çš„ãªç”»åƒãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                } catch (error) {
                    console.error('[figureMaker] Generation failed:', error);
                    showError(error.message || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } finally {
                    setLoadingState(false);
                    updateCustomButtonState();
                }
            }

            // ç”»åƒã‚’ä¿®æ­£ã™ã‚‹å…±é€šã®é–¢æ•°
            async function handleFixImage(type) {
                const historyItem = imageHistory[currentImageIndex];
                if (!historyItem) {
                    showError('ä¿®æ­£ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                elements.errorMessage.classList.add('hidden');

                const customPrompt = elements.customFixPrompt.value.trim();
                if (type === 'custom' && !customPrompt) {
                    showError('ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                updateGlobalImageState(historyItem.imageData, historyItem.promptText);
                let fixPrompt = '';

                // ãƒ­ã‚´ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
                if (type === 'logo') {
                    isClickToFixMode = !isClickToFixMode; // ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒˆã‚°ãƒ«
                    if (isClickToFixMode) {
                        // --- ON: ã‚¯ãƒªãƒƒã‚¯å¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ ---
                        wasCopyrightWarningVisibleBeforeClickMode = !elements.copyrightWarning.classList.contains('hidden');
                        elements.copyrightWarning.classList.add('hidden');
                        elements.downloadBtn.classList.add('hidden');
                        elements.copyAllPromptsBtn.classList.add('hidden');

                        // ãƒ­ã‚´ä¿®æ­£ãƒœã‚¿ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¡¨ç¤ºã«å¤‰æ›´
                        elements.fixLogoBtn.innerHTML = `<span class="material-symbols-outlined text-sm">close</span> ã‚­ãƒ£ãƒ³ã‚»ãƒ«`;
                        elements.fixLogoBtn.classList.remove('bg-blue-400', 'hover:bg-blue-500');
                        elements.fixLogoBtn.classList.add('bg-red-500', 'hover:bg-red-600');

                        setImageLoadingState(true, 'ä¿®æ­£ã—ãŸã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', false);
                        elements.fixLogoBtn.disabled = false;
                        elements.imageLoadingOverlay.classList.add('click-to-fix-cursor');
                        elements.imageLoadingOverlay.scrollIntoView({ behavior: 'smooth', block: 'center', });
                    } else {
                        // --- OFF: ã‚¯ãƒªãƒƒã‚¯å¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã™ã‚‹ ---
                        setImageLoadingState(false);
                        elements.imageLoadingOverlay.classList.remove('click-to-fix-cursor');
                        updateCustomButtonState();

                        elements.downloadBtn.classList.remove('hidden');
                        elements.copyAllPromptsBtn.classList.remove('hidden');
                        if (wasCopyrightWarningVisibleBeforeClickMode) {
                            elements.copyrightWarning.classList.remove('hidden');
                        }

                        // ãƒ­ã‚´ä¿®æ­£ãƒœã‚¿ãƒ³ã‚’å…ƒã®è¡¨ç¤ºã«æˆ»ã™
                        elements.fixLogoBtn.innerHTML = `<span class="material-symbols-outlined text-sm">edit</span> ãƒ­ã‚´ä¿®æ­£`;
                        elements.fixLogoBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                        elements.fixLogoBtn.classList.add('bg-blue-400', 'hover:bg-blue-500');
                    }
                    return;
                }

                // UIã®å³æ™‚ç„¡åŠ¹åŒ–ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã®ãŸã‚ã€setImageLoadingStateã‚’å…ˆã«å‘¼ã³å‡ºã™
                let message;
                if (type === 'custom') {
                    message = 'ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºã‚’é©ç”¨ä¸­';
                } else if (type === 'closeup') {
                    message = 'ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ä¸­';
                } else {
                    message = 'ã•ã‚‰ã«å¼·åŒ–ä¸­';
                }
                setImageLoadingState(true, message);
                if (type === 'custom') {
                    elements.customFixPrompt.value = customPrompt;
                }

                try {
                    if (type === 'custom') {
                        fixPrompt = await translateText(customPrompt, 'ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºã‚’ç¿»è¨³ä¸­...');
                    } else if (type === 'closeup') {
                        fixPrompt = 'highly detailed, close-up shot, extreme focus on the subject, zoomed in to fill the frame, large subject size';
                    } else if (type === 'enhance') {
                        // --- ã€Œã•ã‚‰ã«å¼·åŒ–ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã‚¿ã‚¤ãƒ—åˆ¥æœ€é©åŒ–ï¼‰ ---
                        const figureType = elements.typeSelect.value;
                        let enhancePrompts = {};

                        // ã‚¿ã‚¤ãƒ—åˆ¥å¼·åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å®šç¾©
                        enhancePrompts = {
                            // æ—¢å­˜ã®ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚¿ã‚¤ãƒ—
                            pvc: `Dramatically enhance the photorealism of this image to look like a high-end commercial PVC figure. Maximize surface detail, emphasize sharp edges, apply subtle light bloom on glossy areas, and refine the matte texture of the skin. CRITICAL: The subject must unmistakably look like a solid, painted plastic object.`,
                            nendoroid: `Transform this image to strongly resemble an authentic Nendoroid figure. Maximize the smooth, matte paint finish and rounded, chibi proportions. Sharpen the plastic texture and lighting to emphasize its collectible toy quality. CRITICAL: The subject must maintain its characteristic Nendoroid look.`,
                            clay: `Rework this image to look more like a highly detailed, handcrafted polymer clay sculpture. Emphasize the unique texture of the clay, showing subtle tool marks and imperfections. Refine the painted details and lighting for a unique, one-of-a-kind art piece. CRITICAL: The subject must clearly look like a sculpture made of real clay.`,
                            stand: `Maximize the photorealism and clarity of this acrylic stand figure. Emphasize the laser-cut edges and clear plastic transparency. Sharpen the printing details and enhance the reflective gloss of the acrylic surface. CRITICAL: The subject must maintain its appearance as a clear acrylic stand.`,
                            key: `Maximize the photorealism and clarity of this acrylic keychain figure. Emphasize the clear plastic transparency and the texture of the keyring attachment. Sharpen the printed details and enhance the light reflection on the glossy surface. CRITICAL: The subject must maintain its appearance as a clear acrylic keychain.`,
                            toy: `Dramatically enhance the soft texture and realism of this plush toy. Emphasize the stitching, fabric weave, and cotton filling texture. Apply realistic soft lighting and shadow for a professional, high-quality plush toy photo. CRITICAL: The subject must clearly look like a soft, fluffy plush toy.`,
                            cos: `Apply professional photo retouching to maximize the realism, detail, and lighting quality of this image. Enhance skin texture, sharpen focus, and refine color grading to achieve the quality of a high-end photography magazine. CRITICAL: The subject must look like a real, professionally photographed cosplayer.`,
                            ghibli: `Maximize the quality of this Studio Ghibli style illustration. Enhance the soft, pastel color palette, clarify the 2D hand-drawn lines, and add fine detail to the background art. CRITICAL: The subject must maintain the distinct aesthetic of a hand-drawn Ghibli animation.`,
                        };
                        // ãƒ™ãƒ¼ã‚¹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—ã€‚æœªå®šç¾©ãªã‚‰æ±ç”¨çš„ãªå¼·åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨
                        const baseEnhancementPrompt = enhancePrompts[figureType] || `Apply a highly subtle, non-destructive image processing pass. Maximize the photorealistic quality, sharpness, detail, and surface texture realism of the existing figure without altering its pose, design, or colors. CRITICAL: This is a professional retouch.`;
                        // ä¿®æ­£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ï¼ˆã“ã“ã§ã¯ã€Œã•ã‚‰ã«å¼·åŒ–ã€ãªã®ã§è¿½åŠ ã®ç¦æ­¢äº‹é …ã¯ä¸è¦ï¼‰
                        fixPrompt = baseEnhancementPrompt;
                    }

                    const fixPayload = {
                        contents: [{ parts: [
                            { text: fixPrompt, },
                            { inlineData: { mimeType: 'image/jpeg', data: currentImageData, }, },
                        ], },],
                        safetySettings: [{ category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE", },],
                        generationConfig: { responseModalities: ['TEXT', 'IMAGE',], },
                    };

                    const fixedBase64Data = await generateImageWithRetry(fixPayload, 6, message, true);

                    // Positive Prompt ã«ã‚«ã‚¹ã‚¿ãƒ ä¿®æ­£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
                    if (fixPrompt) {
                        if (lastPositivePrompt.trim() !== '') {
                            lastPositivePrompt += `\nCustomPrompt: ${fixPrompt}, `;
                        } else {
                            lastPositivePrompt = fixPrompt;
                        }
                    }

                    const promptToSave = (type === 'custom') ? customPrompt : historyItem.promptText;
                    updateImageHistory(fixedBase64Data, promptToSave);

                } catch (error) {
                    console.error('[figureMaker] ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    showError(error.message || 'ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    if (type === 'custom') {
                        elements.customFixPrompt.value = customPrompt;
                    }
                } finally {
                    setImageLoadingState(false);
                    updateCustomButtonState();
                }
            }

            async function generateImageWithRetry(payload, maxRetries, loadingMessage, isImageOverlay = false) {
                for (let i = 0; i < maxRetries; i++) {
                    const fullMessage = `${loadingMessage}... ï¼ˆRetry ${i}/${maxRetries - 1}ï¼‰`;
                    if (isImageOverlay) {
                        elements.imageLoadingText.textContent = fullMessage;
                    } else {
                        updateLoadingText(fullMessage);
                    }

                    try {
                        const result = await callGeminiAPI(payload);
                        const textPart = result.candidates?.[0]?.content?.parts?.find(p => p.text);
                        if (textPart && textPart.text) {
                            console.error("[figureMaker] API Text Response:", textPart.text); // è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                            throw new Error('APIãŒãƒ†ã‚­ã‚¹ãƒˆã§å¿œç­”ã—ã¾ã—ãŸã€‚');   // UIã«ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        }
                        const base64Data = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        if (base64Data) {
                            return base64Data;
                        }
                    } catch (error) {
                        console.error(`[figureMaker] Attempt ${i + 1} failed:`, error.message);
                        if (i === maxRetries - 1) {
                            throw new Error(`ã™ã¹ã¦ã®ãƒªãƒˆãƒ©ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\næœ€å¾Œã®è©¦è¡Œã®ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        }
                        await new Promise(res => setTimeout(res, 2000 * (i + 1)));
                    }
                }
                throw new Error('ã™ã¹ã¦ã®ãƒªãƒˆãƒ©ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }

            function updateLoadingText(message) {
                if (elements.loading.classList.contains('hidden')) {
                    return;
                }
                elements.loadingText.textContent = message;
            }

            function setLoadingState(isLoading, message = '') {
                if (isLoading) {
                    elements.generateBtn.disabled = true;
                    elements.actionArea.classList.add('hidden');
                    elements.errorMessage.classList.add('hidden');
                    elements.outputSection.classList.remove('hidden');
                    elements.loading.classList.remove('hidden');
                    elements.resultContainer.classList.add('hidden');
                    elements.copyrightWarning.classList.add('hidden');
                    elements.loadingText.textContent = message;

                    const animations = ['anim-bounce', 'anim-spin-bounce', 'anim-wiggle', 'anim-waddle',];
                    const icons = Array.from(elements.loadingAnimation.children);
                    icons.forEach(icon => icon.className = 'hidden');
                    const randomIndex = Math.floor(Math.random() * animations.length);
                    icons[randomIndex].className = animations[randomIndex];

                    elements.loading.scrollIntoView({ behavior: 'smooth', block: 'center', });
                } else {
                    elements.generateBtn.disabled = false;
                    elements.loading.classList.add('hidden');
                    updateActionButtonsState();
                }
            }

            // ç”»åƒä¸Šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
            function setImageLoadingState(isLoading, message = 'ç”»åƒã‚’ç”Ÿæˆä¸­...', showAnimation = true) {
                if (isLoading) {
                    elements.imageLoadingOverlay.classList.remove('hidden');
                    elements.imageLoadingText.textContent = message;
                    if (showAnimation) {
                        const animations = ['anim-bounce', 'anim-spin-bounce', 'anim-wiggle', 'anim-waddle',];
                        const icons = Array.from(elements.imageLoadingAnimation.children);
                        icons.forEach(icon => icon.className = 'hidden');
                        const randomIndex = Math.floor(Math.random() * animations.length);
                        icons[randomIndex].className = animations[randomIndex];
                        elements.imageLoadingAnimation.classList.remove('hidden');
                    } else {
                        elements.imageLoadingAnimation.classList.add('hidden');
                    }
                    window.requestAnimationFrame(() => {
                        elements.imageLoadingOverlay.scrollIntoView({ behavior: 'smooth', block: 'center', });
                    });
                } else {
                    elements.imageLoadingOverlay.classList.add('hidden');
                    elements.imageLoadingText.textContent = '';
                    elements.imageLoadingAnimation.classList.remove('hidden');
                }
                updateActionButtonsState();
            }

            // ç”»åƒã®å±¥æ­´ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            function updateImageHistory(newImageData, newPromptText = '') {
                // ã€Œã‚„ã‚Šç›´ã™ã€å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
                imageHistory = imageHistory.slice(0, currentImageIndex + 1);
                // æ–°ã—ã„å±¥æ­´ã‚’è¿½åŠ 
                imageHistory.push({
                    imageData: newImageData,
                    promptText: newPromptText,
                    positivePrompt: lastPositivePrompt,
                    negativePrompt: lastNegativePrompt,
                });
                // å±¥æ­´ãŒä¸Šé™ã‚’è¶…ãˆãŸå ´åˆã€æœ€ã‚‚å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
                if (imageHistory.length > MAX_HISTORY_SIZE) {
                    imageHistory.shift();
                }
                currentImageIndex = imageHistory.length - 1;
                displayCurrentImage(true);
            }

            function updateGlobalImageState(imageData, promptText) {
                currentImageData = imageData;
                currentImagePrompt = promptText;
                displayCurrentImage(false);
            }

            // ç¾åœ¨ã®ç”»åƒã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
            function displayCurrentImage(shouldScroll = true) {
                const historyItem = imageHistory[currentImageIndex];
                if (historyItem) {
                    const jpegDataUrl = `data:image/jpeg;base64,${historyItem.imageData}`;
                    elements.generatedImage.src = jpegDataUrl;

                    // æ¬¡ã®å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
                    const nextHistoryItem = imageHistory[currentImageIndex + 1];
                    if (nextHistoryItem) {
                        elements.customFixPrompt.value = nextHistoryItem.promptText || '';
                    } else {
                        elements.customFixPrompt.value = historyItem.promptText || '';
                    }

                    elements.resultContainer.classList.remove('hidden');
                    elements.outputSection.classList.remove('hidden');
                    elements.actionArea.classList.remove('hidden');

                    if (shouldScroll) {
                        elements.outputSection.scrollIntoView({ behavior: 'smooth', });
                    }

                    // ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å±¥æ­´å«ã‚ã‚‹ ---
                    lastPositivePrompt = historyItem.positivePrompt || lastPositivePrompt;
                    lastNegativePrompt = historyItem.negativePrompt || lastNegativePrompt;
                    // æ›´æ–°ã•ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®å†…å®¹ã‚’æ›´æ–°
                    elements.promptOutputTooltip.textContent = `${lastPositivePrompt}\n${lastNegativePrompt}`;
                    updateActionButtonsState();
                    updateCustomButtonState();
                }
            }

            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ãŸã¡ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’ã¾ã¨ã‚ã¦ç®¡ç†ã™ã‚‹é–¢æ•°
            function updateActionButtonsState() {
                const isLoading = !elements.imageLoadingOverlay.classList.contains('hidden');
                const hasImage = currentImageIndex > -1;

                elements.fixLogoBtn.disabled = !hasImage || isLoading;
                elements.fixCloseupBtn.disabled = !hasImage || isLoading;
                elements.furtherFigureBtn.disabled = !hasImage || isLoading;
                elements.customFixPrompt.disabled = !hasImage || isLoading;
                elements.applyCustomBtn.disabled = !hasImage || isLoading;
                elements.undoBtn.disabled = currentImageIndex <= 0 || isLoading;
                elements.redoBtn.disabled = (currentImageIndex >= imageHistory.length - 1) || isLoading;
                elements.flipImageBtn.disabled = !uploadedImageData;
            }

            // ã‚«ã‚¹ã‚¿ãƒ ä¿®æ­£ã®é€ä¿¡ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            function updateCustomButtonState() {
                const customPrompt = elements.customFixPrompt.value.trim();
                const isDisabled = customPrompt.length === 0;
                elements.applyCustomBtn.disabled = isDisabled;
            }

            function updateResetButtonVisibility() {
                const hasText = elements.additionalPrompt.value.trim().length > 0 ||
                                elements.additionalNegativePrompt.value.trim().length > 0;
                if (hasText) {
                    elements.resetPromptsButton.classList.remove('opacity-0', 'pointer-events-none');
                } else {
                    elements.resetPromptsButton.classList.add('opacity-0', 'pointer-events-none');
                }
            }

            // å…ƒã«æˆ»ã™
            function undoImage() {
                if (currentImageIndex > 0) {
                    currentImageIndex--;
                    displayCurrentImage(false);
                }
            }

            // ã‚„ã‚Šç›´ã™
            function redoImage() {
                if (currentImageIndex < imageHistory.length - 1) {
                    currentImageIndex++;
                    displayCurrentImage(false);
                }
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯æ™‚ã«PNGå¤‰æ›ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
            function handleDownload(e) {
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆå³æ™‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰ã‚’æ­¢ã‚ã‚‹
                e.preventDefault();

                const historyItem = imageHistory[currentImageIndex];
                if (!historyItem) {
                    return;
                }

                const jpegDataUrl = `data:image/jpeg;base64,${historyItem.imageData}`;
                const img = new Image();
                const shouldFlip = isImageFlipped; // åè»¢çŠ¶æ…‹ã‚’å–å¾—

                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ã‚°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã™ã‚‹
                elements.downloadBtn.classList.add('opacity-50', 'pointer-events-none');
                elements.downloadBtn.disabled = true;

                // ä»¥å‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLãŒã‚ã‚Œã°è§£æ”¾ã™ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ã®ãŸã‚ã€å‡¦ç†ã®æœ€åˆã«å®Ÿè¡Œï¼‰
                if (elements.downloadBtn.dataset.tempUrl) {
                    URL.revokeObjectURL(elements.downloadBtn.dataset.tempUrl);
                    delete elements.downloadBtn.dataset.tempUrl;
                }

                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');

                        if (shouldFlip) {
                            ctx.scale(-1, 1);             // 1. Xè»¸ã‚’åè»¢ï¼ˆ-1å€ï¼‰ã™ã‚‹
                            ctx.translate(-img.width, 0); // 2. ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å·¦ã«ç§»å‹•ï¼ˆåè»¢ã—ãŸåˆ†ã€ç”»åƒå¹…åˆ†ãƒã‚¤ãƒŠã‚¹æ–¹å‘ã«ç§»å‹•ï¼‰
                        }

                        ctx.drawImage(img, 0, 0);

                        if (shouldFlip) {
                            ctx.setTransform(1, 0, 0, 1, 0, 0); // åº§æ¨™ç³»ã‚’å…ƒã«æˆ»ã™ (æ¬¡ã®å‡¦ç†ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ãŸã‚ã€å³å¯†ã«ã¯ä¸è¦ãªå ´åˆã‚‚ã‚ã‚‹)
                        }

                        const pngDataUrl = canvas.toDataURL('image/png');

                        // Data URLã‹ã‚‰Blobã‚’ä½œæˆã—ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’ç”Ÿæˆã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
                        fetch(pngDataUrl)
                            .then(res => res.blob())
                            .then(blob => {
                                const tempUrl = URL.createObjectURL(blob);

                                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼
                                const a = document.createElement('a');
                                a.href = tempUrl;
                                a.download = `figure_maker_${getFormattedDateTime()}.png`;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);

                                // ä¸€æ™‚URLã‚’ä¿æŒ (è§£æ”¾ã®ãŸã‚)
                                elements.downloadBtn.dataset.tempUrl = tempUrl;
                            })
                            .catch(e => {
                                console.error("[figureMaker] ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
                                showError('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                            })
                            .finally(() => {
                                // å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                                elements.downloadBtn.classList.remove('opacity-50', 'pointer-events-none');
                                elements.downloadBtn.disabled = false;
                            });
                    } catch (e) {
                        console.error("[figureMaker] PNGå¤‰æ›ä¸­ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
                        showError('PNGã¸ã®å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                        elements.downloadBtn.classList.remove('opacity-50', 'pointer-events-none');
                        elements.downloadBtn.disabled = false;
                    }
                };

                img.onerror = () => {
                    console.error("[figureMaker] ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    showError('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    elements.downloadBtn.classList.remove('opacity-50', 'pointer-events-none');
                    elements.downloadBtn.disabled = false;
                };

                // ç”»åƒã®ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹
                img.src = jpegDataUrl;
            }

            function showError(message) {
                const htmlMessage = message.replace(/\n/g, '<br>');
                elements.errorMessage.innerHTML = htmlMessage;
                elements.errorMessage.classList.remove('hidden');
                elements.errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center', });
            }

            // ========= ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° =========
            // @param {string} msg - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            // @param {boolean|null} isSuccess - æˆåŠŸã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚° (nullã®å ´åˆã¯æ¢ç´¢ä¸­)
            function showToast(msg, isSuccess) {
                const toastId = 'figure-toast';
                console.log(`[TOAST] ${msg}`);

                if (toastTimeoutId) {
                    clearTimeout(toastTimeoutId);
                    toastTimeoutId = null;
                }

                // 20msé…å»¶ã•ã›ã¦ã€é‡ã„DOMæ“ä½œä¸­ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç«¶åˆã‚’å›é¿
                setTimeout(() => {
                    const existingToast = document.getElementById(toastId);
                    if (existingToast) {
                        existingToast.remove();
                    }

                    const toast = document.createElement('div');
                    toast.textContent = msg;
                    toast.id = toastId;
                    toast.classList.add('figure-toast');

                    let bgColor;
                    if (isSuccess === true) {
                        bgColor = '#007bff';
                    } else if (isSuccess === false) {
                        bgColor = '#dc3545';
                    } else {
                        bgColor = '#6c757d';
                    }

                    toast.style.cssText = `
                        position: fixed; bottom: 0px; left: 50%; transform: translateX(-50%);
                        background: ${bgColor}; color: white; padding: 4px 20px;
                        border-radius: 14px; z-index: 100000;
                        height: 24px;
                        font-size: 14px; transition: opacity 1.0s ease, transform 1.0s ease; opacity: 0;
                    `;
                    toast.style.display = 'flex';          // Flexboxæœ‰åŠ¹åŒ–
                    toast.style.alignItems = 'center';     // å‚ç›´æ–¹å‘ã®ä¸­å¤®æƒãˆ
                    toast.style.justifyContent = 'center'; // æ°´å¹³æ–¹å‘ã®ä¸­å¤®æƒãˆ
                    document.body.appendChild(toast);

                    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
                    setTimeout(() => {
                        toast.style.opacity = '1';
                        toast.style.transform = 'translate(-50%, -16px)';
                    }, 10);

                    // è‡ªå‹•éè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
                    if (isSuccess !== null) {
                        toastTimeoutId = setTimeout(() => {
                            toast.style.opacity = '0';
                            toast.style.transform = 'translate(-50%, 0)';
                            setTimeout(() => {
                                if (document.body.contains(toast)) {
                                    toast.remove();
                                }
                                if (toastTimeoutId) {
                                    toastTimeoutId = null;
                                }
                            }, 1000);
                        }, 3000);
                    }
                }, 20);
            }

            function getFormattedDateTime() {
                const now = new Date();
                return `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
            }

            function copyToClipboard(text, buttonElement) {
                if (!text) {
                    return;
                }
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed'; textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalIcon = buttonElement.innerHTML;
                    buttonElement.innerHTML = `<span class="material-symbols-outlined text-sm text-green-400">check</span>`;
                    setTimeout(() => {
                        buttonElement.innerHTML = originalIcon;
                    }, 1500);
                } catch (err) {
                    console.error('[figureMaker] Copy failed', err);
                    showError('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
                document.body.removeChild(textArea);
            }
        });
    </script>
</body>
</html>
